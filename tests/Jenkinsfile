pipeline {
    agent {
        docker {
            //image 'playwright/chromium:playwright-1.56.1'
            image 'mcr.microsoft.com/playwright:v1.57.0-noble'
            args '--user=root --entrypoint=""'
        }
    }
     parameters {
            choice(name:"navigateur",choices:["chromium","webkit","firefox"],description:"selectionner un navigateur  pour le test")

        }

    stages {
        stage('Display versions') {
            steps {
                sh 'node --version'
                sh 'npm --version'
            }
        }
        stage(" CLONE DU PROJET"){
            steps{
                // sh 'apt-get update && apt-get install -y git'
                sh "rm -rf repo"
                echo 'version du git'
                sh 'git --version'
                sh "git clone https://github.com/Ausni/Playwright_jenkins.git repo"
                sh "ls -la repo"
                  dir('repo'){
                    // sh "npm install"
                    // sh "npx playwright install"
                    sh "npm ci"
                    script{
                        if(params.navigateur=="chromium")
                        {
                             sh "npx playwright test --project=chromium --grep '@smoke' --reporter=allure-playwright"
                             stash name: 'allure-results', includes: 'allure-results/*'
                        }
                    }
                   
                }
            }
        }
        
      
    }
   
    post {
        // always;success;faillure
        //always
        success{
            script{
                // build job:'job_valide'
                sh 'rm -rf allure-results/*'
                unstash 'allure-results'
                archiveArtifacts 'allure-results/*'
                allure includeProperties: false,
                jdk: '',       
                results: [[path: 'allure-results/']]
                }
            }
        }


}